#!/bin/bash
set -e

# Function to check if a VyOS firewall group exists
check_firewall_group_exists() {
    local group_type="$1"
    local group_name="$2"

    echo "Checking if $group_type '$group_name' exists..."
    # Use show command to check if group exists
    if /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper show firewall group "$group_type" "$group_name" < /dev/null >/dev/null 2>&1; then
        echo "$group_type '$group_name' exists."
        return 0  # Group exists
    else
        echo "$group_type '$group_name' does not exist."
        return 1  # Group does not exist
    fi
}

case "$1" in
    configure)
        echo "Configuring VyOS IP Blocklist Generator..."

        # Check if we're running on VyOS
        if [ -f "/opt/vyatta/sbin/vyatta-cfg-cmd-wrapper" ]; then
            echo "VyOS detected, configuring firewall groups..."

            # Track if we made any changes
            changes_made=false

            # Create VyOS firewall groups automatically
            echo "Starting VyOS configuration session..."
            /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin < /dev/null
            echo "VyOS configuration session started."

            # Check and create IPv4 network group if it doesn't exist
            if check_firewall_group_exists "network-group" "threats-blocklist-ipv4"; then
                echo "IPv4 firewall group 'threats-blocklist-ipv4' already exists, skipping creation"
            else
                echo "Creating IPv4 firewall group 'threats-blocklist-ipv4'"
                echo "Setting IPv4 group..."
                /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group network-group threats-blocklist-ipv4 description 'IPv4 Threat Intelligence (auto-created)' < /dev/null
                echo "IPv4 group set."
                changes_made=true
            fi

            # Check and create IPv6 network group if it doesn't exist
            if check_firewall_group_exists "ipv6-network-group" "threats-blocklist-ipv6"; then
                echo "IPv6 firewall group 'threats-blocklist-ipv6' already exists, skipping creation"
            else
                echo "Creating IPv6 firewall group 'threats-blocklist-ipv6'"
                echo "Setting IPv6 group..."
                /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group ipv6-network-group threats-blocklist-ipv6 description 'IPv6 Threat Intelligence (auto-created)' < /dev/null
                echo "IPv6 group set."
                changes_made=true
            fi

            # Commit the changes only if we made any
            if [ "$changes_made" = true ]; then
                echo "Committing firewall group changes..."
                echo "Running commit..."
                if /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit --yes < /dev/null; then
                    echo "Commit successful."
                    echo "✓ VyOS firewall groups created successfully"
                else
                    echo "⚠ Warning: Failed to commit VyOS configuration"
                    echo "Ending session..."
                    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper end < /dev/null
                    echo "Session ended."
                    exit 1
                fi
            else
                echo "No changes needed for firewall groups"
            fi

            echo "Ending VyOS configuration session..."
            /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper end < /dev/null
            echo "VyOS configuration session ended."

            echo ""
            echo "VyOS firewall groups created! Next steps:"
            echo "1. Configure firewall rules to use these groups:"
            echo "   set firewall ipv4 forward filter rule 12 source group network-group 'threats-blocklist-ipv4'"
            echo "   set firewall ipv6 forward filter rule 16 source group ipv6-network-group 'threats-blocklist-ipv6'"
            echo "2. Run: vyos-ipblock --verbose"
            echo "3. Run: /config/scripts/sync-vyos-threats.sh"

        else
            echo "Non-VyOS system detected, skipping firewall group creation"
        fi

        # Create directories for configuration files
        mkdir -p /config/scripts
        mkdir -p /var/log/vyos-ipblock

        # Set proper permissions
        chmod 755 /config/scripts
        chmod 755 /var/log/vyos-ipblock

        echo ""
        echo "VyOS IP Blocklist Generator installed successfully!"
        echo "Configuration files: /config/scripts/"
        echo "Logs: /var/log/vyos-ipblock/"
        echo ""
        echo "Quick start:"
        echo "1. Test: vyos-ipblock --dry-run --verbose"
        echo "2. Run: vyos-ipblock --verbose"
        echo "3. Enable automation: sudo systemctl enable --now vyos-ipblock.timer"
        echo "4. Enable abuse reporting: sudo systemctl enable --now vyos-abuse-reporter.timer"

        # Disable the abuse reporter timer by default to prevent automatic reporting
        if command -v systemctl >/dev/null 2>&1; then
            echo "Disabling vyos-abuse-reporter.timer by default..."
            systemctl disable vyos-abuse-reporter.timer >/dev/null 2>&1 || true
            echo "Abuse reporter timer disabled. Enable manually if desired."
        fi
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#

exit 0
