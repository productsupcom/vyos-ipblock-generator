#!/usr/bin/make -f

export DH_VERBOSE=1

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_build:
	# Skip automatic build since we're installing a single script

override_dh_auto_test:
	# Skip tests during package build

override_dh_auto_install:
	# Create directories
	mkdir -p debian/vyos-ipblock/usr/bin
	mkdir -p debian/vyos-ipblock/usr/share/doc/vyos-ipblock/examples
	mkdir -p debian/vyos-ipblock/usr/lib/systemd/system
	mkdir -p debian/vyos-ipblock/lib/systemd/system
	mkdir -p debian/vyos-ipblock/etc/logrotate.d

	# Install the main scripts
	install -m 755 generate_blocklist.py debian/vyos-ipblock/usr/bin/vyos-ipblock
	install -m 755 report_blocked_ips.py debian/vyos-ipblock/usr/bin/vyos-abuse-reporter

	# Install configuration examples (create if missing)
	test -f whitelist.txt.example || echo "# Example whitelist" > whitelist.txt.example
	install -m 644 whitelist.txt.example debian/vyos-ipblock/usr/share/doc/vyos-ipblock/examples/

	# Skip systemd service installation for VyOS compatibility - use cron instead

	# Install systemd service files
	install -m 644 debian/vyos-abuse-reporter.service debian/vyos-ipblock/lib/systemd/system/
	install -m 644 debian/vyos-abuse-reporter.timer debian/vyos-ipblock/lib/systemd/system/
	install -m 644 debian/vyos-ipblock.service debian/vyos-ipblock/lib/systemd/system/
	install -m 644 debian/vyos-ipblock.timer debian/vyos-ipblock/lib/systemd/system/

	# Install logrotate configuration (create if missing)
	test -f debian/vyos-ipblock.logrotate || echo "/var/log/vyos-ipblock/*.log {\n    daily\n    rotate 7\n    compress\n}" > debian/vyos-ipblock.logrotate
	install -m 644 debian/vyos-ipblock.logrotate debian/vyos-ipblock/etc/logrotate.d/vyos-ipblock

override_dh_installsystemd:
	dh_installsystemd --no-enable

override_dh_python3:
	dh_python3
