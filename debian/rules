#!/usr/bin/make -f

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_build:
	# Skip automatic build since we're installing a single script

override_dh_auto_test:
	# Skip tests during package build

override_dh_auto_install:
	# Create directories
	mkdir -p debian/vyos-ipblock/usr/bin
	mkdir -p debian/vyos-ipblock/usr/share/doc/vyos-ipblock/examples
	mkdir -p debian/vyos-ipblock/usr/lib/systemd/system
	mkdir -p debian/vyos-ipblock/etc/logrotate.d
	
	# Install the main script
	install -m 755 generate_blocklist.py debian/vyos-ipblock/usr/bin/vyos-ipblock
	
	# Install configuration examples (create if missing)
	test -f whitelist.txt.example || echo "# Example whitelist" > whitelist.txt.example
	install -m 644 whitelist.txt.example debian/vyos-ipblock/usr/share/doc/vyos-ipblock/examples/

	# Install systemd service and timer (create if missing)
	test -f debian/vyos-ipblock.service || echo "[Unit]\nDescription=VyOS IP Blocklist Generator\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/vyos-ipblock\nUser=root\nStandardOutput=journal\nStandardError=journal" > debian/vyos-ipblock.service
	test -f debian/vyos-ipblock.timer || echo "[Unit]\nDescription=VyOS IP Blocklist Timer\nRequires=vyos-ipblock.service\n\n[Timer]\nOnCalendar=*-*-* 00,06,12,18:00:00\nRandomizedDelaySec=300\nPersistent=true\n\n[Install]\nWantedBy=timers.target" > debian/vyos-ipblock.timer
	install -m 644 debian/vyos-ipblock.service debian/vyos-ipblock/usr/lib/systemd/system/
	install -m 644 debian/vyos-ipblock.timer debian/vyos-ipblock/usr/lib/systemd/system/
	
	# Create and install logrotate configuration
	echo '/var/log/vyos-ipblock/*.log {' > debian/vyos-ipblock.logrotate
	echo '    daily' >> debian/vyos-ipblock.logrotate
	echo '    rotate 7' >> debian/vyos-ipblock.logrotate
	echo '    compress' >> debian/vyos-ipblock.logrotate
	echo '    delaycompress' >> debian/vyos-ipblock.logrotate
	echo '    missingok' >> debian/vyos-ipblock.logrotate
	echo '    notifempty' >> debian/vyos-ipblock.logrotate
	echo '    create 0644 root root' >> debian/vyos-ipblock.logrotate
	echo '}' >> debian/vyos-ipblock.logrotate
	install -m 644 debian/vyos-ipblock.logrotate debian/vyos-ipblock/etc/logrotate.d/vyos-ipblock

	# Install the sync script template
	cat > debian/vyos-ipblock/usr/share/doc/vyos-ipblock/examples/sync-vyos-threats.sh << 'EOF'
#!/bin/bash
# VyOS Threat Intelligence Sync Script
# This script syncs nftables sets to VyOS network groups
# Install to: /config/scripts/sync-vyos-threats.sh

echo "Syncing threat intelligence to VyOS network groups..."

# Function to sync IPv4 threats
sync_ipv4_threats() {
    echo "Syncing IPv4 threats..."
    
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete firewall group network-group threats-blocklist-ipv4 address 2>/dev/null || true
    
    sudo nft list set ip vyos_filter N_threats-blocklist-ipv4 2>/dev/null | \
        grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}(/[0-9]{1,2})?' | \
        head -1000 | \
        while read ip; do
            /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group network-group threats-blocklist-ipv4 address "$$ip"
        done
    
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper end
    
    local count=$$(sudo nft list set ip vyos_filter N_threats-blocklist-ipv4 2>/dev/null | grep -c elements || echo "0")
    echo "IPv4 threats synced: $$count entries"
}

# Function to sync IPv6 threats
sync_ipv6_threats() {
    echo "Syncing IPv6 threats..."
    
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper begin
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper delete firewall group ipv6-network-group threats-blocklist-ipv6 address 2>/dev/null || true
    
    sudo nft list set ip6 vyos_filter N6_threats-blocklist-ipv6 2>/dev/null | \
        grep -oE '([0-9a-fA-F:]+:+)+[0-9a-fA-F]+(/[0-9]{1,3})?' | \
        head -1000 | \
        while read ip; do
            /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper set firewall group ipv6-network-group threats-blocklist-ipv6 address "$$ip"
        done
    
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper commit
    /opt/vyatta/sbin/vyatta-cfg-cmd-wrapper end
    
    local count=$$(sudo nft list set ip6 vyos_filter N6_threats-blocklist-ipv6 2>/dev/null | grep -c elements || echo "0")
    echo "IPv6 threats synced: $$count entries"
}

sync_ipv4_threats
sync_ipv6_threats
echo "Threat intelligence sync completed"
EOF
	chmod 755 debian/vyos-ipblock/usr/share/doc/vyos-ipblock/examples/sync-vyos-threats.sh

override_dh_python3:
	dh_python3
